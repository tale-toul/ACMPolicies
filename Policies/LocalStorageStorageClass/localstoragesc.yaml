apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/description: Discovery of local volumes and creation of storage class for the Local Storage Operator
  name: ls-storage-class
  namespace: policies
spec:
  disabled: true
  policy-templates:
#Label All Nodes for ODF
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: ls-node-label
      spec:
        pruneObjectBehavior: None
        remediationAction: enforce
        severity: high
        object-templates:
        - complianceType: musthave
          object-templates-raw: |
            {{- range (lookup "v1" "Node" "" "").items }}
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Node
                metadata:
                  labels:
                    cluster.ocs.openshift.io/openshift-storage: ""
                  name: {{ .metadata.name }}
            {{- end }}
#Discover Local Disks
  - extraDependencies:
     - apiVersion: policy.open-cluster-management.io/v1
       kind: ConfigurationPolicy
       name: ls-node-label
       namespace: ""
       compliance: Compliant
    objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: ls-discover-volume
      spec:
        pruneObjectBehavior: None
        remediationAction: enforce
        severity: high
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: local.storage.openshift.io/v1alpha1
            kind: LocalVolumeDiscovery
            metadata:
              name: auto-discover-devices
              namespace: openshift-local-storage
            spec:
              nodeSelector:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: cluster.ocs.openshift.io/openshift-storage
                    operator: Exists
